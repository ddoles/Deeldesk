# Business Model Summary Implementation Plan

**Feature:** AI-Generated Organization Business Model Summary  
**Status:** Implementation Plan  
**Last Updated:** January 2025

---

## Overview

This plan implements an AI-generated business model summary for the user's own organization, stored in `organizations.settings` JSONB and accessible via the Knowledge Base section. The summary provides persistent company-level context for all proposal generations.

---

## Architecture Decision

### Storage: Dedicated `company_profiles` Table

**Updated Decision:** Use a dedicated table instead of JSONB for better queryability, version history, and structured data.

**Rationale:**
- **Better queryability** — Can query by industry, company size, verification status
- **Type-safe enums** — Generated_by, confidence level as database enums
- **Version history support** — Built-in version tracking field
- **Structured fields** — Separate columns for overview, value proposition, etc.
- **Audit trail** — Clear tracking of who generated/edited and when
- **Cleaner API** — Direct field access vs. JSON extraction

**Database Schema:**
```sql
CREATE TABLE company_profiles (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID UNIQUE NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,

  -- Business Model Summary
  summary TEXT,                       -- Main business model description

  -- Company Details (structured for better querying)
  company_overview TEXT,
  value_proposition TEXT,
  target_customers TEXT,
  revenue_model TEXT,
  key_differentiators TEXT[] DEFAULT '{}',

  -- Industry & Market
  industry VARCHAR(100),
  market_segment VARCHAR(100),
  company_size VARCHAR(50),           -- e.g., "startup", "smb", "enterprise"
  founded_year INTEGER,
  headquarters VARCHAR(255),
  website TEXT,

  -- Generation Metadata
  generated_at TIMESTAMP WITH TIME ZONE,
  generated_by generated_by,          -- ENUM: 'ai', 'user'
  confidence confidence_level,        -- ENUM: 'high', 'medium', 'low'
  sources TEXT[] DEFAULT '{}',        -- URLs used for generation

  -- Verification
  is_verified BOOLEAN NOT NULL DEFAULT false,
  verified_at TIMESTAMP WITH TIME ZONE,

  -- Edit tracking
  last_edited_at TIMESTAMP WITH TIME ZONE,
  last_edited_by UUID REFERENCES users(id),

  -- Version tracking (for history)
  version INTEGER NOT NULL DEFAULT 1,

  -- Timestamps
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

**Prisma Model:**
```prisma
model CompanyProfile {
  id             String          @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  organizationId String          @unique @map("organization_id") @db.Uuid

  // Business Model Summary
  summary        String?

  // Company Details
  companyOverview    String?     @map("company_overview")
  valueProposition   String?     @map("value_proposition")
  targetCustomers    String?     @map("target_customers")
  revenueModel       String?     @map("revenue_model")
  keyDifferentiators String[]    @default([]) @map("key_differentiators")

  // Industry & Market
  industry       String?         @db.VarChar(100)
  marketSegment  String?         @map("market_segment") @db.VarChar(100)
  companySize    String?         @map("company_size") @db.VarChar(50)
  foundedYear    Int?            @map("founded_year")
  headquarters   String?         @db.VarChar(255)
  website        String?

  // Generation Metadata
  generatedAt    DateTime?       @map("generated_at") @db.Timestamptz
  generatedBy    GeneratedBy?    @map("generated_by")
  confidence     ConfidenceLevel?
  sources        String[]        @default([])

  // Verification
  isVerified     Boolean         @default(false) @map("is_verified")
  verifiedAt     DateTime?       @map("verified_at") @db.Timestamptz

  // Edit tracking
  lastEditedAt   DateTime?       @map("last_edited_at") @db.Timestamptz
  lastEditedById String?         @map("last_edited_by") @db.Uuid

  // Version tracking
  version        Int             @default(1)

  // Relations
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lastEditedBy   User?           @relation("LastEditedBy", fields: [lastEditedById], references: [id])

  @@map("company_profiles")
}
```

---

## Implementation Tasks

### Phase 1: Backend Foundation (8 points)

#### Task 1.1: Database Schema Updates
**File:** `prisma/schema.prisma`
**Points:** 1

- ✅ Schema already created with dedicated `company_profiles` table
- Enums already defined: `generated_by`, `confidence_level`
- Update TypeScript types in `types/company-profile.ts`

**Files to modify:**
- `types/company-profile.ts` - Add `CompanyProfile` interface (generated by Prisma)

---

#### Task 1.2: Business Model Generation Service
**File:** `lib/ai/business-model-generator.ts` (new)  
**Points:** 5

**Responsibilities:**
- Use LLM with web search capability to research organization
- Generate structured business model summary
- Return summary with confidence score and sources

**Implementation:**
```typescript
// lib/ai/business-model-generator.ts
export interface BusinessModelSummary {
  summary: string;
  confidence: 'high' | 'medium' | 'low';
  sources: string[];
}

export async function generateBusinessModelSummary(
  organizationName: string,
  organizationDomain?: string
): Promise<BusinessModelSummary> {
  // 1. Use LLM with web search to research company
  // 2. Generate summary covering:
  //    - Company overview
  //    - Value proposition
  //    - Target customers
  //    - Revenue model
  //    - Key differentiators
  // 3. Return with confidence and sources
}
```

**Dependencies:**
- LLM provider (Anthropic Claude with web search or similar)
- Web search API (Tavily, Serper, or LLM-native search)

**Files to create:**
- `lib/ai/business-model-generator.ts`

---

#### Task 1.3: API Endpoints
**Files:** `app/api/knowledge/business-model/route.ts` (new)  
**Points:** 2

**Endpoints:**

```typescript
// GET /api/knowledge/business-model
// Returns current business model summary for organization

// POST /api/knowledge/business-model/generate
// Triggers AI generation, returns summary

// PUT /api/knowledge/business-model
// Updates business model summary (user edits)
// Body: { summary: string, is_verified?: boolean }
```

**Files to create:**
- `app/api/knowledge/business-model/route.ts`
- `app/api/knowledge/business-model/generate/route.ts`

**Files to modify:**
- `lib/db/queries/organizations.ts` - Add helper functions for updating settings

---

### Phase 2: Context Assembly Integration (3 points)

#### Task 2.1: Update Context Assembly Engine
**File:** `lib/ai/context.ts`
**Points:** 3

**Changes:**
- Retrieve company profile from dedicated `company_profiles` table
- Include in `AssembledContext` when present
- Add to system prompt for proposal generation

**Implementation:**
```typescript
// lib/ai/context.ts
export async function assembleContext(
  opportunityId: string,
  organizationId: string
): Promise<AssembledContext> {
  // Retrieve company profile from dedicated table
  const companyProfile = await prisma.companyProfile.findUnique({
    where: { organizationId }
  });

  // Build business model context from structured fields
  const businessModelContext = companyProfile ? {
    summary: companyProfile.summary,
    companyOverview: companyProfile.companyOverview,
    valueProposition: companyProfile.valueProposition,
    targetCustomers: companyProfile.targetCustomers,
    keyDifferentiators: companyProfile.keyDifferentiators,
    industry: companyProfile.industry,
    isVerified: companyProfile.isVerified,
  } : null;

  return {
    // ... existing context
    companyProfile: businessModelContext,  // Always included when present
    products: await getRelevantProducts(opportunityId),
    battlecards: await getRelevantBattlecards(opportunityId),
    playbooks: await getRelevantPlaybooks(opportunityId),
    // ...
  };
}
```

**Files to modify:**
- `lib/ai/context.ts` - Add company profile retrieval
- `lib/ai/prompts/system-prompt.ts` - Include company profile in prompt template

---

### Phase 3: Frontend UI (8 points)

#### Task 3.1: Knowledge Base Navigation Update
**File:** `docs/design/NAVIGATION_SYSTEM.md`, `app/(dashboard)/knowledge/layout.tsx`  
**Points:** 1

**Changes:**
- Add "Company Profile" or "About Us" to Knowledge Base navigation
- Update navigation structure

**Navigation structure:**
```
/knowledge
├── /knowledge/products
├── /knowledge/battlecards
├── /knowledge/playbooks
├── /knowledge/branding
└── /knowledge/company-profile  ← NEW
```

**Files to modify:**
- `app/(dashboard)/knowledge/layout.tsx` - Add navigation item
- `docs/design/NAVIGATION_SYSTEM.md` - Update documentation

---

#### Task 3.2: Company Profile Page
**File:** `app/(dashboard)/knowledge/company-profile/page.tsx` (new)  
**Points:** 4

**UI Components:**
- Display current business model summary (if exists)
- "Generate with AI" button (if not generated or user wants to regenerate)
- Editable text area for summary
- Save button
- "Verified" checkbox
- Loading states for generation
- Confidence indicator and sources (if available)

**UI Structure:**
```
┌─────────────────────────────────────────────────┐
│  Company Profile                    [Generate]   │
├─────────────────────────────────────────────────┤
│                                                  │
│  Business Model Summary                         │
│  ┌───────────────────────────────────────────┐  │
│  │ [Editable text area with current summary] │  │
│  │                                           │  │
│  │ [AI Generated] Last updated: Jan 15, 2025 │  │
│  │ Sources: company.com, linkedin.com       │  │
│  └───────────────────────────────────────────┘  │
│                                                  │
│  ☑ I have verified this information             │
│                                                  │
│  [Save Changes]                                 │
└─────────────────────────────────────────────────┘
```

**Empty State:**
```
┌─────────────────────────────────────────────────┐
│  Company Profile                                 │
├─────────────────────────────────────────────────┤
│                                                  │
│  No business model summary yet.                 │
│                                                  │
│  Generate an AI-powered summary based on        │
│  publicly available information about your      │
│  company. You can edit and refine it after.    │
│                                                  │
│  [Generate with AI]                             │
│                                                  │
└─────────────────────────────────────────────────┘
```

**Files to create:**
- `app/(dashboard)/knowledge/company-profile/page.tsx`
- `components/knowledge/CompanyProfileEditor.tsx`

**Files to modify:**
- `app/(dashboard)/knowledge/layout.tsx` - Add route

---

#### Task 3.3: Generation UI Flow
**File:** `components/knowledge/CompanyProfileEditor.tsx`  
**Points:** 3

**Features:**
- Loading state during generation
- Error handling for generation failures
- Success state with generated summary
- Edit mode toggle
- Save confirmation

**Files to create:**
- `components/knowledge/CompanyProfileEditor.tsx`
- `components/knowledge/BusinessModelGenerator.tsx` (if needed)

---

### Phase 4: Integration & Testing (3 points)

#### Task 4.1: Update System Prompts
**File:** `lib/ai/prompts/system-prompt.ts`  
**Points:** 1

**Changes:**
- Include business model summary in system prompt template
- Add instructions for how to use business model context

**Prompt addition:**
```
BUSINESS MODEL CONTEXT:
${businessModel || 'No business model summary available.'}

Use this context to:
- Align value propositions with company positioning
- Ensure messaging consistency
- Reference company differentiators appropriately
```

**Files to modify:**
- `lib/ai/prompts/system-prompt.ts`

---

#### Task 4.2: Testing
**Points:** 2

**Test Cases:**
1. Generate business model summary via API
2. Update business model summary via API
3. Verify context assembly includes business model
4. Test UI generation flow
5. Test UI editing and saving
6. Verify business model appears in proposal generation prompts

**Files to create:**
- `tests/api/knowledge/business-model.test.ts`
- `tests/lib/ai/business-model-generator.test.ts`
- `tests/lib/ai/context.test.ts` (update existing)

---

## File Structure

### New Files

```
lib/
├── ai/
│   └── business-model-generator.ts  (new)
│
app/
├── api/
│   └── knowledge/
│       └── business-model/
│           ├── route.ts  (new)
│           └── generate/
│               └── route.ts  (new)
│
├── (dashboard)/
│   └── knowledge/
│       └── company-profile/
│           └── page.tsx  (new)
│
components/
└── knowledge/
    ├── CompanyProfileEditor.tsx  (new)
    └── BusinessModelGenerator.tsx  (new, optional)
│
types/
└── organization.ts  (modify - add BusinessModelSummary interface)
```

### Modified Files

```
lib/
├── ai/
│   ├── context.ts  (add business model retrieval)
│   └── prompts/
│       └── system-prompt.ts  (include business model in prompt)
│
app/
└── (dashboard)/
    └── knowledge/
        └── layout.tsx  (add navigation item)

docs/
└── design/
    └── NAVIGATION_SYSTEM.md  (update navigation structure)
```

---

## API Specification

### GET /api/knowledge/company-profile

Returns current company profile for the authenticated user's organization.

**Response:**
```json
{
  "id": "uuid",
  "summary": "Acme Corp is a B2B SaaS platform...",
  "companyOverview": "Founded in 2015, Acme Corp provides...",
  "valueProposition": "We help enterprises reduce operational costs by 40%...",
  "targetCustomers": "Mid-market and enterprise companies in financial services...",
  "revenueModel": "SaaS subscription with usage-based pricing...",
  "keyDifferentiators": ["AI-powered automation", "Enterprise-grade security", "24/7 support"],
  "industry": "Enterprise Software",
  "marketSegment": "B2B SaaS",
  "companySize": "startup",
  "foundedYear": 2015,
  "headquarters": "San Francisco, CA",
  "website": "https://acme.com",
  "generatedAt": "2025-01-15T10:30:00Z",
  "generatedBy": "ai",
  "confidence": "high",
  "sources": ["https://acme.com", "https://linkedin.com/company/acme"],
  "isVerified": true,
  "verifiedAt": "2025-01-16T09:00:00Z",
  "lastEditedAt": "2025-01-16T14:20:00Z",
  "lastEditedBy": "user_123",
  "version": 2
}
```

**Status Codes:**
- `200` - Success
- `404` - No company profile exists yet

---

### POST /api/knowledge/company-profile/generate

Triggers AI generation of company profile.

**Request Body:**
```json
{
  "organizationName": "Acme Corp",  // Optional, defaults to org name
  "organizationDomain": "acme.com"  // Optional, for better search
}
```

**Response:**
```json
{
  "id": "uuid",
  "summary": "Acme Corp is a B2B SaaS platform...",
  "companyOverview": "Founded in 2015...",
  "valueProposition": "We help enterprises...",
  "targetCustomers": "Mid-market and enterprise...",
  "keyDifferentiators": ["AI-powered automation", "Enterprise-grade security"],
  "industry": "Enterprise Software",
  "generatedAt": "2025-01-15T10:30:00Z",
  "generatedBy": "ai",
  "isVerified": false,
  "sources": ["https://acme.com", "https://linkedin.com/company/acme"],
  "confidence": "high",
  "version": 1
}
```

**Status Codes:**
- `200` - Generation successful (creates or updates)
- `400` - Invalid request
- `429` - Rate limit exceeded (too many generations)
- `500` - Generation failed

---

### PUT /api/knowledge/company-profile

Updates the company profile (user edits).

**Request Body:**
```json
{
  "summary": "Updated business model description...",
  "companyOverview": "Updated overview...",
  "valueProposition": "Updated value prop...",
  "targetCustomers": "Updated target customers...",
  "keyDifferentiators": ["Differentiator 1", "Differentiator 2"],
  "industry": "Technology",
  "isVerified": true
}
```

**Response:**
```json
{
  "id": "uuid",
  "summary": "Updated business model description...",
  "companyOverview": "Updated overview...",
  "valueProposition": "Updated value prop...",
  "generatedAt": "2025-01-15T10:30:00Z",
  "generatedBy": "ai",
  "lastEditedAt": "2025-01-16T14:20:00Z",
  "lastEditedBy": "user_123",
  "isVerified": true,
  "verifiedAt": "2025-01-16T14:20:00Z",
  "version": 2
}
```

**Status Codes:**
- `200` - Update successful
- `400` - Invalid request
- `401` - Unauthorized
- `404` - No company profile exists (use POST to create)

---

## Context Assembly Integration

### Updated Context Structure

```typescript
interface CompanyProfileContext {
  summary: string | null;
  companyOverview: string | null;
  valueProposition: string | null;
  targetCustomers: string | null;
  keyDifferentiators: string[];
  industry: string | null;
  isVerified: boolean;
}

interface AssembledContext {
  // ... existing fields
  companyProfile: CompanyProfileContext | null;  // Organization's company profile
  brandSettings: BrandContext | null;            // Organization's brand settings
  products: Product[];
  battlecards: Battlecard[];
  playbooks: Playbook[];
  // ...
}
```

### System Prompt Integration

The company profile is included in the system prompt as foundational context:

```
You are generating a proposal for [Customer Company].

ORGANIZATION CONTEXT:
Company Overview: ${companyProfile.companyOverview}
Value Proposition: ${companyProfile.valueProposition}
Target Customers: ${companyProfile.targetCustomers}
Key Differentiators: ${companyProfile.keyDifferentiators.join(', ')}
Industry: ${companyProfile.industry}

Use this context to ensure:
- Value propositions align with our company positioning
- Messaging reflects our key differentiators
- Tone and style match our business model
- ${companyProfile.isVerified ? '' : '[Note: Company profile not yet verified by user]'}
```

---

## Implementation Phases

### MVP (Phase 1-3)
- Basic AI generation from organization name
- Simple text summary (not structured sections)
- Edit and save functionality
- Context assembly integration
- Basic UI in Knowledge Base

**Estimated Points:** 19 points

### Phase 4 Enhancements (Future)
- Structured sections (company overview, value prop, etc.)
- Version history
- Staleness detection
- Multiple data sources (Crunchbase, G2, etc.)
- Confidence indicators per section
- Source attribution per section

---

## Dependencies

### External Services
- **LLM Provider:** Anthropic Claude (with web search) or similar
- **Web Search API:** Tavily, Serper, or LLM-native search capability

### Environment Variables
```env
# Existing
ANTHROPIC_API_KEY=sk-ant-...

# New (if using separate search API)
TAVILY_API_KEY=tvly-...  # Optional
SERPER_API_KEY=...  # Optional
```

---

## Security & Privacy Considerations

1. **Rate Limiting:** Limit generation requests (e.g., 5 per day per organization)
2. **Data Privacy:** Only use publicly available information
3. **User Control:** Users can opt for manual-only input
4. **Audit Trail:** Log when summaries are generated/updated

---

## Success Metrics

- **Generation Success Rate:** > 80% (medium+ confidence)
- **User Edit Rate:** 60-80% (indicates engagement)
- **Verification Rate:** > 70% within first week
- **Context Usage:** Business model included in > 90% of proposals (when available)

---

## Decisions

### Web Search Provider Decision

**Decision:** Use **Claude's native web search capability** as the primary provider.

**Rationale:**
- Anthropic Claude 3.5 Sonnet supports native web search via tool use
- Eliminates need for additional third-party API integration
- Reduces operational complexity and cost
- Better integration with existing LLM provider architecture

**Fallback Strategy:**
- If Claude's native search is unavailable or returns insufficient results, fallback to **Tavily API**
- Tavily selected for:
  - Purpose-built for AI applications
  - Structured search results optimized for LLM consumption
  - Competitive pricing ($0.01 per search)
  - Good coverage of business/company information

**Implementation:**
```typescript
// lib/ai/business-model-generator.ts

export async function generateBusinessModelSummary(
  organizationName: string,
  organizationDomain?: string
): Promise<BusinessModelSummary> {
  const provider = await getProviderForOrganization(organizationId);

  // Try Claude native search first
  try {
    const result = await provider.generateCompletion({
      systemPrompt: BUSINESS_MODEL_SYSTEM_PROMPT,
      messages: [{ role: 'user', content: buildResearchPrompt(organizationName, organizationDomain) }],
      tools: [{ type: 'web_search' }], // Claude native search
    });
    return parseBusinessModelResponse(result);
  } catch (error) {
    // Fallback to Tavily if native search fails
    if (shouldUseTavilyFallback(error)) {
      return generateWithTavily(organizationName, organizationDomain);
    }
    throw error;
  }
}
```

**Environment Variable:**
```env
# Optional: Tavily fallback (only needed if Claude native search unavailable)
TAVILY_API_KEY=tvly-...
```

### Other Decisions

| Question | Decision |
|----------|----------|
| Generation Trigger | On-demand only (via Knowledge Base UI). Consider onboarding prompt in Phase 2. |
| Rate Limits | 5 generations/day for Free, 10 for Pro, 20 for Team, unlimited for Enterprise |
| Structured vs. Freeform | Start with freeform text summary (simpler). Structured sections in Phase 2. |

## Open Questions (Resolved)

~~1. **Web Search Provider:** Which service to use? (Tavily, Serper, or LLM-native)~~ **Resolved:** Claude native with Tavily fallback
~~2. **Generation Trigger:** On-demand only, or also prompt during onboarding?~~ **Resolved:** On-demand for MVP
~~3. **Rate Limits:** How many generations per day/week?~~ **Resolved:** See table above
~~4. **Structured vs. Freeform:** Start with simple text or structured sections?~~ **Resolved:** Freeform text for MVP

---

## Next Steps

1. Review and approve this implementation plan
2. Set up web search API access (Tavily/Serper)
3. Begin Phase 1 implementation
4. Test generation quality with sample organizations
5. Iterate based on feedback
